<!DOCTYPE html>
<html>
<head>
  <title>Dashboard - CRM Pedidos</title>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    td{
      background-color: #fff;
      padding: 5px;
      padding: 15px;
    }

    .close {
      background-color: #ff7373;
      border: none;
      border-radius: 5px;
      margin: -5px 0 14px auto;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      display: block;
      border-radius: 30px;
      width: 35px;
      height: 35px;
    }
  </style>
</head>
<body>
  <%- include('partials/sidebar') %>

  <div style="padding: 20px; margin-left: 210px;">
    <h2 class="title-page">Painel de Pedidos</h2>

    <div class="board">
      <% ['OrÃ§amentos', 'Pedidos', 'Arte', 'ProduÃ§Ã£o', 'ExpediÃ§Ã£o', 'Entregue'].forEach(status => { %>
        <div class="column">
          <h3><%= status %></h3>
          <div class="dropzone" data-status="<%= status %>">
            <% (porStatus[status] || []).forEach(p => { %>
              <div class="card" data-id="<%= p.id %>" onclick="abrirPopup(<%= JSON.stringify(p) %>)">
                <strong>#<%= p.id %></strong> - <%= p.nome %>
                <br />
                <small>Total: <%= p.total %></small>
                <br />
                <small>Pagou: R$ <%= p.pago %></small>
              </div>
            <% }) %>
          </div>
        </div>
      <% }) %>
    </div>

    <div id="popup" class="popup"></div>
  </div>
  <script>
    const zonas = document.querySelectorAll('.dropzone');
    zonas.forEach(z => {
      new Sortable(z, {
        group: 'pedidos',
        animation: 150,
        onAdd: async function (evt) {
          const card = evt.item;
          const novoStatus = evt.to.dataset.status;
          const idPedido = card.dataset.id;

          const res = await fetch('/atualizar-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ idPedido, novoStatus })
          });

          if (!res.ok) alert('Erro ao atualizar status.');
        }
      });
    });

    let pedidoAtual = null;

    async function abrirPopup(pedido) {
      pedidoAtual = pedido;
      const popup = document.getElementById('popup');

      // Buscar itens da aba Vendas com mesmo NÂº Pedido
      const res = await fetch('/itens-do-pedido?id=' + pedido.id);
      const itens = await res.json();
      
      popup.innerHTML = `
      <button onclick="document.getElementById('popup').style.display='none'" class="buttons close">X</button>
        <div style="display: flex; justify-content: space-between;">
          <h3>Pedido #${pedido.id} - ${pedido.loja}</h3>
          <div>
            <label>Data de Entrega:</label>
            <input type="date" id="editar-data" value="${pedido.dataEntrega || ''}">
          </div>
        </div>
        <div style="display: flex; gap: 20px;">
          <div class="client">
            <p><strong>Cliente:</strong> ${pedido.nome}</p>
            <p><strong>Telefone:</strong> ${pedido.telefone}</p>
            <p><strong>Email:</strong> ${pedido.email}</p>
            <p><strong>Telefone:</strong> ${pedido.telefone}</p>
              <a href="https://wa.me/55${pedido.telefone}.replace(/\D/g, '')" target="_blank">ðŸ“² WhatsApp</a><br>
          </div>
          <div class="client">
            <p><strong>Valor Total:</strong> <span>${pedido.total}</span></p>
            <p><strong>Desconto:</strong> <span>${pedido.desconto}</span></p>
            <div>
              <label>Valor Pago: <input type="text" id="editar-pago" value="${pedido.pago.replace('R$ ','')}" style="width: 90px; font-size: 1em; text-align: right;"></label>
            </div>
            <p><strong>Valor Restante:</strong> <span>${pedido.restante}</span></p>
            
          </div>
          <div class="client">
            <label>ObservaÃ§Ã£o:</label>
            <textarea type="text" id="editar-obs" value="" style="min-height: 90px;">${pedido.observacao || ''}</textarea>
          </div>
        </div>

        <h4 class="division">Itens do Pedido</h4>
        <table id="tabela-editar-itens">
          <thead>
            <tr><th>Produto</th><th>Qtd</th><th>Desconto</th><th>Valor Pago</th><th>Forma</th><th>Obs</th></tr>
          </thead>
          <tbody>
            ${itens.map((item, i) => `
              ${console.log(item)}
              <tr>
                <td>${item.produto}</td>
                <td>${item.qtd}</td>
                <td>${item.desconto}</td>
                <td>${item.valorPago}</td>
                <td>${item.formaPagamento}</td>
                <td>${item.observacao}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        
       <button onclick="salvarAlteracoes()" class="buttons">ðŸ’¾ Salvar AlteraÃ§Ãµes</button>
      `;
      popup.style.display = 'block';
    }

    async function salvarAlteracoes() {

      const payload = {
        id: pedidoAtual.id,
        pago: parseFloat(document.getElementById('editar-pago').value),
        dataEntrega: document.getElementById('editar-data').value,
        observacao: document.getElementById('editar-obs').value,
      };

      const res = await fetch('/editar-pedido', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (res.ok) {
        alert('Pedido atualizado!');
        location.reload();
      } else {
        alert('Erro ao salvar alteraÃ§Ãµes.');
      }
    }

  </script>
</body>
</html>
